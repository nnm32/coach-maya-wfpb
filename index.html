<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Coach Maya ‚Äî Whole-Food, Plant-Based Coach</title>
<meta name="description" content="Coach Maya: photoreal avatar + natural voice with WFPB check-ins and email reminders (single-file).">
<style>
  :root{
    --bg:#0f172a;--ink:#e5e7eb;--muted:#9ca3af;--accent:#22c55e;--accent2:#86efac;--card:#0b1324;--line:#1f2937;
    --gold:#d9b45a;--hair:#2b1a12;--skin1:#f1c08a;--skin2:#c98a5a;--lip:#a15a4a;--blush:#e9a0a0;
  }
  *{box-sizing:border-box}
  body{margin:0;font-family:system-ui,-apple-system,Segoe UI,Roboto,sans-serif;background:radial-gradient(1000px 700px at 20% -10%,#1e293b 0%,var(--bg) 60%);color:var(--ink);min-height:100vh;display:grid;place-items:center;padding:24px}
  .app{width:100%;max-width:980px}
  header{display:flex;align-items:center;gap:10px;margin-bottom:16px}
  header h1{font-size:1.1rem;margin:0;color:var(--accent2)}
  .tag{padding:2px 8px;border:1px solid var(--line);border-radius:999px;color:var(--muted);font-size:12px}
  .grid{display:grid;gap:16px}
  @media(min-width:900px){.grid{grid-template-columns:360px 1fr}}
  .card{background:linear-gradient(180deg,rgba(255,255,255,.03),rgba(255,255,255,0));border:1px solid var(--line);border-radius:16px;padding:18px;box-shadow:0 10px 30px rgba(0,0,0,.25)}
  .coach{background:var(--card);border:1px solid var(--line);border-radius:16px;padding:20px;text-align:center}

  /* ---- Video avatar ---- */
  #mayaVideo{width:220px;height:auto;border-radius:14px;display:block;margin:8px auto;box-shadow:0 6px 20px rgba(0,0,0,.4)}
  #avatarFallback{display:none}

  /* ---- CSS fallback avatar (only shows if video fails) ---- */
  .avatar{position:relative;width:220px;height:260px;margin:8px auto 12px;filter:drop-shadow(0 8px 18px rgba(0,0,0,.35))}
  .torso{position:absolute; left:50%; bottom:0; transform:translateX(-50%); width:200px; height:110px; background:linear-gradient(180deg,#6b7280,#4b5563); border-radius:100px 100px 12px 12px; border:1px solid #394150;}
  .cardi{position:absolute; left:50%; bottom:40px; transform:translateX(-50%); width:210px; height:130px; background:linear-gradient(180deg,#f1a6a6,#d77777); border-radius:120px 120px 20px 20px; border:1px solid #7a3a3a; opacity:.9;}
  .headWrap{position:absolute; left:50%; top:28px; transform:translateX(-50%);}
  .head{position:relative; width:180px; height:200px; border-radius:48% 52% 46% 54%/52% 48% 54% 46%; background:radial-gradient(70% 70% at 50% 32%, var(--skin1), var(--skin2) 75%); border:2px solid #b37a49; animation:float 4s ease-in-out infinite;}
  @keyframes float{0%,100%{transform:translateY(0)}50%{transform:translateY(-4px)}}
  .hairCap{position:absolute; inset:-8px -10px auto -10px; height:120px; border-radius:60% 60% 40% 40%; background:radial-gradient(120% 80% at 50% 30%, #3a251a, var(--hair)); z-index:2;}
  .sideWave{position:absolute; width:36px; height:54px; background:var(--hair); top:58px; border-radius:60% 40% 60% 40%;}
  .sideWave.left{left:-6px; transform:rotate(-12deg)} .sideWave.right{right:-6px; transform:rotate(12deg)}
  .babyHair{position:absolute; width:36px; height:18px; top:88px; background:linear-gradient(180deg,transparent,rgba(43,26,18,.7)); border-radius:50px;}
  .babyHair.left{left:8px; transform:rotate(-12deg)} .babyHair.right{right:8px; transform:rotate(12deg)}
  .bun{position:absolute; width:90px; height:90px; background:radial-gradient(120% 100% at 50% 30%, #3b261b, var(--hair)); border-radius:50%; left:50%; top:-28px; transform:translateX(-50%); box-shadow:0 6px 0 rgba(0,0,0,.08) inset;}
  .ear{position:absolute; top:92px; width:26px; height:34px; background:linear-gradient(180deg,var(--skin1),var(--skin2)); border:2px solid #b37a49; border-radius:50px; z-index:1;}
  .ear.left{left:-10px} .ear.right{right:-10px}
  .earring{position:absolute; width:22px; height:22px; border:3px solid var(--gold); border-radius:50%; top:116px; background:transparent; box-shadow:0 0 6px rgba(217,180,90,.4);}
  .earring.left{left:-14px} .earring.right{right:-14px}
  .eye{position:absolute; top:92px; width:24px; height:24px; background:#1a1a1a; border-radius:50%;}
  .eye.left{left:52px} .eye.right{right:52px}
  .eye::after{content:''; position:absolute; width:7px; height:7px; background:#fff; border-radius:50%; top:4px; left:10px}
  .blink{animation:blink 6s infinite}
  @keyframes blink{0%,96%,100%{transform:scaleY(1)}97%,99%{transform:scaleY(0.1)}}
  .brow{position:absolute; top:76px; width:46px; height:14px; border-top:5px solid #3a261b; border-radius:60px; opacity:.9;}
  .brow.left{left:40px; transform:rotate(-6deg)} .brow.right{right:40px; transform:rotate(6deg)}
  .lash{position:absolute; top:100px; width:30px; height:10px; border-bottom:3px solid #1a1410; border-radius:0 0 60px 60px; opacity:.85;}
  .lash.left{left:46px; transform:rotate(-8deg)} .lash.right{right:46px; transform:rotate(8deg)}
  .nose{position:absolute; top:118px; left:50%; transform:translateX(-50%); width:24px; height:18px; border-left:3px solid rgba(133,84,50,.7); border-right:3px solid rgba(133,84,50,.7); border-radius:0 0 18px 18px; opacity:.7;}
  .cheek{position:absolute; top:132px; width:38px; height:22px; background:radial-gradient(65% 80% at 50% 50%, var(--blush), transparent 65%); opacity:.6; border-radius:50px;}
  .cheek.left{left:28px} .cheek.right{right:28px}
  .mouth{position:absolute; left:50%; bottom:48px; transform:translateX(-50%); width:72px; height:34px; background:linear-gradient(180deg,#f4c19c,#e9b289); border:4px solid #8e563f; border-top:none; border-radius:0 0 60px 60px; box-shadow:0 -6px 0 var(--lip) inset;}
  .mouth.talking{animation:talk 360ms ease-in-out infinite}
  @keyframes talk{0%,100%{transform:translateX(-50%) scaleY(0.85)}50%{transform:translateX(-50%) scaleY(1.22)}}

  .speech{font-size:.95rem;color:var(--ink);background:#0b1324;border:1px solid #1e293b;border-radius:12px;padding:12px;min-height:48px}
  .small{color:var(--muted);font-size:.85rem}
  label{font-size:.9rem;color:var(--muted)}
  input,select{width:100%;padding:12px 14px;border-radius:10px;border:1px solid var(--line);background:#0b1220;color:var(--ink)}
  button{appearance:none;border:none;border-radius:12px;padding:10px 14px;font-weight:600;color:#0a0f1f;background:linear-gradient(180deg,var(--accent),#16a34a);cursor:pointer}
  button.secondary{background:#111827;color:var(--ink);border:1px solid var(--line)}
  .row{display:flex;gap:10px;flex-wrap:wrap;align-items:center}
  .pill{padding:6px 10px;border-radius:999px;background:#0b1324;border:1px solid var(--line);color:var(--muted);font-size:12px}
  .history{display:flex;gap:8px;flex-wrap:wrap;margin-top:8px}
  .dot{width:10px;height:10px;border-radius:50%;background:#374151}
  .dot.ok{background:var(--accent)}
  .goalbox{display:grid;gap:8px}
  .qrow{display:grid;gap:8px;margin-top:8px}
  .confetti{pointer-events:none;position:fixed;inset:0;overflow:hidden}
  .confetti i{position:absolute;width:10px;height:14px;background:hsl(var(--h),90%,60%);top:-20px;opacity:.9;animation:fall 1400ms linear forwards}
  @keyframes fall{to{transform:translateY(120vh) rotate(360deg);opacity:1}}
  .danger{color:#fca5a5}
  .success{color:#86efac}
</style>
</head>
<body>
<div class="app">
  <header>
    <h1>Coach Maya ‚Äî Whole-Food, Plant-Based</h1>
    <span class="tag">Photoreal video avatar ‚Ä¢ Email reminders ‚Ä¢ Local data</span>
  </header>

  <div class="grid">
    <!-- COACH PANEL -->
    <div class="coach card" aria-live="polite">
      <!-- Video avatar (photoreal). Fallback shows CSS avatar if video fails -->
      <video id="mayaVideo" src="maya_idle.mp4" playsinline autoplay muted loop></video>
      <div id="avatarFallback">
        <div class="avatar" aria-hidden="true">
          <div class="torso"></div><div class="cardi"></div>
          <div class="headWrap">
            <div class="head">
              <div class="bun"></div><div class="hairCap"></div>
              <div class="sideWave left"></div><div class="sideWave right"></div>
              <div class="babyHair left"></div><div class="babyHair right"></div>
              <div class="ear left"></div><div class="ear right"></div>
              <div class="earring left"></div><div class="earring right"></div>
              <div class="brow left"></div><div class="brow right"></div>
              <div class="eye left blink"></div><div class="eye right blink"></div>
              <div class="lash left"></div><div class="lash right"></div>
              <div class="nose"></div><div class="cheek left"></div><div class="cheek right"></div>
              <div class="mouth" id="mouth"></div>
            </div>
          </div>
        </div>
      </div>

      <div id="coachLine" class="speech">
        Hi! I‚Äôm <b>Maya</b>, your friendly lifestyle coach. Let‚Äôs build tiny, powerful habits together.
      </div>

      <div class="row" style="margin-top:10px">
        <span class="pill" id="streakPill">Streak: 0</span>
        <span class="pill" id="todayPill"></span>
      </div>

      <div class="row" style="margin-top:8px">
        <button class="secondary" id="btnVoice">üîà Voice Off</button>
        <select id="voiceSelect" title="Select a voice"></select>
        <button class="secondary" id="btnTestVoice" title="Test voice">‚ñ∂Ô∏é Test</button>
      </div>
      <p class="small" style="margin-top:6px">Tip: iPhone/iPad may need one tap on ‚ÄúTest‚Äù to enable audio.</p>
      <p class="small">‚ùñ Clearing this site‚Äôs data/history erases local progress (by design).</p>
    </div>

    <!-- MAIN PANEL -->
    <div class="card">
      <!-- AUTH -->
      <section id="authSection">
        <h2 style="margin-top:0">Login</h2>
        <label>Username</label>
        <input id="username" autocomplete="username" />
        <label>Password</label>
        <input id="password" type="password" autocomplete="current-password" />
        <div class="row" style="margin-top:8px">
          <button id="btnLogin">Login</button>
          <button class="secondary" id="btnNew">Create / Reset Account</button>
        </div>
        <p class="small">‚ö†Ô∏è Demo only: simple local password (not for PHI).</p>
      </section>

      <!-- ONBOARDING -->
      <section id="introSection" hidden>
        <h2>Welcome! Let‚Äôs personalize your coach.</h2>
        <label>What should Maya call you?</label>
        <input id="displayName" placeholder="Your first name" />
        <div style="margin-top:12px">
          <h3 style="margin:0 0 6px">What is a Whole-Food, Plant-Based (WFPB) diet?</h3>
          <p class="small">
            Foods from plants ‚Äî vegetables, fruits, whole grains, legumes, nuts, seeds ‚Äî in their most natural form.
            Less processed foods, added sugars, and refined grains. More color, fiber, and real nourishment.
            Benefits: better energy, weight balance, digestion, heart health, and lower inflammation.
          </p>
        </div>

        <label>Your one-line motivation for this change</label>
        <input id="motivation" placeholder="e.g., I want more energy / lower cholesterol / feel good in my body" />

        <div style="margin-top:12px">
          <h3 style="margin:0 0 6px">Get gentle reminders (EmailJS)</h3>
          <label>Email</label>
          <input id="email" type="email" placeholder="you@example.com" />
          <label>Frequency</label>
          <select id="freq">
            <option value="DAILY">Daily</option>
            <option value="MWF">Mon ‚Ä¢ Wed ‚Ä¢ Fri</option>
            <option value="WEEKLY">Weekly</option>
          </select>
          <label>Preferred local time (HH:MM)</label>
          <input id="hour" placeholder="08:00" />
          <div class="row" style="margin-top:8px">
            <button id="btnSaveIntro">Save & Continue</button>
            <span id="introMsg" class="small"></span>
          </div>
          <p class="small">Emails are sent while the page is open; on your next visit, Maya ‚Äúcatches up‚Äù any overdue nudges.</p>
        </div>
      </section>

      <!-- DAILY CHECK-IN -->
      <section id="checkinSection" hidden>
        <div class="row" style="justify-content:space-between;align-items:center">
          <h2 style="margin:0">üåø Daily Check-In</h2>
          <button class="secondary" id="btnLogout">Logout</button>
        </div>
        <p id="welcomeLine" class="small"></p>

        <div class="goalbox">
          <div class="qrow">
            <label>1Ô∏è‚É£ Did you eat colorful non-starchy veggies today?</label>
            <input id="qVeg" placeholder='yes/no or a few words (e.g., "broccoli")' />
          </div>
          <div class="qrow">
            <label>2Ô∏è‚É£ Any beans, peas, or lentils?</label>
            <input id="qLeg" placeholder='yes/no or e.g., "dal/chickpeas"' />
          </div>
          <div class="qrow">
            <label>3Ô∏è‚É£ Whole fruit instead of juice?</label>
            <input id="qFruit" placeholder='yes/no or e.g., "banana"' />
          </div>
          <div class="qrow">
            <label>4Ô∏è‚É£ Any whole grains?</label>
            <input id="qGrain" placeholder='yes/no or e.g., "brown rice"' />
          </div>
        </div>

        <div class="row" style="margin-top:12px">
          <button id="btnSave">Submit</button>
          <span id="saveMsg" class="small"></span>
        </div>

        <div id="result" style="margin-top:16px"></div>

        <div style="margin-top:12px">
          <div class="small">History (past 10 days):</div>
          <div class="history" id="historyDots" aria-label="History dots"></div>
        </div>
      </section>
    </div>
  </div>
</div>

<div class="confetti" id="confetti"></div>

<!-- EmailJS SDK (client-side email) -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<script>
/* ================= CONFIG: EmailJS ================= */
const EMAIL_ENABLED = true;        // flip to false to disable emails
const EMAILJS_PUBLIC_KEY = "YOUR_EMAILJS_PUBLIC_KEY";
const EMAILJS_SERVICE_ID = "YOUR_SERVICE_ID";
const EMAILJS_TEMPLATE_ID = "YOUR_TEMPLATE_ID";
/* Template vars used: to_email, to_name, subject, message */

/* ====== Storage & basics ====== */
const KEY_USERS="lm_app_users";
const KEY_SESSION="lm_app_session";
const $=s=>document.querySelector(s);
const today=new Date(); $("#todayPill").textContent=new Intl.DateTimeFormat(undefined,{dateStyle:"medium"}).format(today);
function loadUsers(){return JSON.parse(localStorage.getItem(KEY_USERS)||"{}");}
function saveUsers(u){localStorage.setItem(KEY_USERS,JSON.stringify(u));}
function loadSession(){return JSON.parse(sessionStorage.getItem(KEY_SESSION)||"null");}
function saveSession(s){sessionStorage.setItem(KEY_SESSION,JSON.stringify(s));}
function clearSession(){sessionStorage.removeItem(KEY_SESSION);}
function hash(str){let h=0;for(let i=0;i<str.length;i++){h=Math.imul(31,h)+str.charCodeAt(i)|0;}return "h"+(h>>>0).toString(16);}

/* ====== Video fallback handling ====== */
const videoEl = document.getElementById('mayaVideo');
const fallbackEl = document.getElementById('avatarFallback');
videoEl.addEventListener('error', ()=>{ videoEl.style.display="none"; fallbackEl.style.display="block"; });
videoEl.addEventListener('loadeddata', ()=>{ fallbackEl.style.display="none"; });

/* ====== Voice: force US-English, clean ====== */
let selectedVoice=null;
const preferredVoices=[/Google US English/i,/Samantha/i,/Allison/i,/Aria Online.*\(Natural\)/i,/Jenny/i];
function pickUSVoice(list){
  let us=list.filter(v=>/^en-US/i.test(v.lang));
  for(const re of preferredVoices){ const hit=us.find(v=>re.test(v.name)); if(hit) return hit; }
  if(us.length) return us[0];
  const en=list.filter(v=>/^en/i.test(v.lang)); return en[0]||list[0]||null;
}
function initVoices(){
  if(!('speechSynthesis' in window)) return;
  const voices=speechSynthesis.getVoices();
  selectedVoice = pickUSVoice(voices);
  const sel=document.getElementById('voiceSelect');
  sel.innerHTML="";
  voices.forEach(v=>{
    const opt=document.createElement('option');
    opt.value=v.name; opt.textContent=`${v.name} ‚Äî ${v.lang}`;
    if(selectedVoice && v.name===selectedVoice.name) opt.selected=true;
    sel.appendChild(opt);
  });
  sel.addEventListener('change', ()=>{ const ch=voices.find(v=>v.name===sel.value); if(ch) selectedVoice=ch; });
}
if('speechSynthesis' in window){ speechSynthesis.onvoiceschanged=initVoices; initVoices(); }
const btnVoice=$("#btnVoice"), btnTest=$("#btnTestVoice");
let voiceOn=false;
btnVoice.addEventListener("click",()=>{ voiceOn=!voiceOn; btnVoice.textContent = voiceOn? "üîä Voice On" : "üîà Voice Off"; if(voiceOn) speakLine("Hi, I am Coach Maya. Let's take one small step today."); });
btnTest.addEventListener("click",()=> speakLine("Testing voice. Sounds good!"));
function speakLine(text){
  return new Promise(res=>{
    if(!voiceOn || !('speechSynthesis' in window) || !text) return res();
    speechSynthesis.cancel();
    const u=new SpeechSynthesisUtterance(text);
    if(selectedVoice) u.voice=selectedVoice;
    u.rate=1.02; u.pitch=1.02; u.lang=(selectedVoice&&selectedVoice.lang)||'en-US';
    u.onend=res; u.onerror=res; speechSynthesis.speak(u);
  });
}
async function speakQueue(lines){ for(const l of lines){ await speakLine(l); await new Promise(r=>setTimeout(r,180)); } }

/* ====== Coach text helpers ====== */
const coachLine=$("#coachLine");
function talk(text){ coachLine.innerHTML=text; if(voiceOn) speakLine(text); }
function confetti(){ const c=$("#confetti"); for(let i=0;i<100;i++){const p=document.createElement("i"); p.style.setProperty("--h",Math.floor(Math.random()*360)); p.style.left=Math.random()*100+"vw"; p.style.animationDelay=(Math.random()*0.5)+"s"; c.appendChild(p); setTimeout(()=>p.remove(),1800);} }

/* ====== EmailJS helpers ====== */
(function emailInit(){ if(!EMAIL_ENABLED) return; try{ emailjs.init(EMAILJS_PUBLIC_KEY);}catch(e){console.warn("EmailJS init error",e);} })();
async function sendEmail(to_email,to_name,subject,message){
  if(!EMAIL_ENABLED || !to_email) return;
  try{ await emailjs.send(EMAILJS_SERVICE_ID,EMAILJS_TEMPLATE_ID,{to_email,to_name,subject,message}); }
  catch(e){ console.warn("Email failed",e); }
}

/* ====== Reminders (client-only) ====== */
const MIN=60*1000, H12=12*60*MIN;
function toMinutes(hhmm="08:00"){ const [h,m]=(hhmm||"").split(":").map(Number); return (!Number.isFinite(h)||!Number.isFinite(m))?480:(h*60+m); }
function computeNextFreqDue(msNow,freq,hour){
  const hm=toMinutes(hour); const d=new Date(msNow);
  let next=new Date(d); next.setHours(Math.floor(hm/60), hm%60, 0, 0);
  if(next.getTime()<=msNow) next=new Date(next.getTime()+24*60*MIN);
  if(freq==="DAILY") return next.getTime();
  if(freq==="WEEKLY") return next.getTime()+6*24*60*MIN;
  if(freq==="MWF"){ const isMWF=(dt)=>[1,3,5].includes(dt.getDay()); while(!isMWF(next)) next=new Date(next.getTime()+24*60*MIN); return next.getTime(); }
  return next.getTime();
}
function maybeSendOverdueReminder(user){
  if(!user?.reminder?.email) return;
  const now=Date.now();
  if(user.nextDueFreq && now>=user.nextDueFreq){
    sendEmail(user.reminder.email,user.name,"Coach Maya ‚Äî quick check-in","Ready for a 30-second check-in? Tiny steps: add 1/2 cup beans, a handful of greens, whole fruit, or a whole-grain swap.");
    user.nextDueFreq = computeNextFreqDue(now+MIN, user.reminder.freq, user.reminder.hour);
  }
  if(user.nextDueInactivity && now>=user.nextDueInactivity){
    sendEmail(user.reminder.email,user.name,"Coach Maya ‚Äî we miss you üíö","Haven‚Äôt seen you in a while ‚Äî want to check in? Even one tiny step today counts.");
    user.nextDueInactivity = now + H12;
  }
}
setInterval(()=>{ const s=loadSession(); const users=loadUsers(); if(!s||!users[s.username]) return; const user=users[s.username]; maybeSendOverdueReminder(user); users[s.username]=user; saveUsers(users); },60*1000);

/* ====== UI & app state ====== */
const streakPill=$("#streakPill"), welcomeLine=$("#welcomeLine"), historyDots=$("#historyDots");
function updateStreak(user){ streakPill.textContent=`Streak: ${user.streak||0}`; }
function updateHistory(user){ const days=[]; const now=new Date(); for(let i=9;i>=0;i--){const d=new Date(now); d.setDate(now.getDate()-i); const k=d.toISOString().slice(0,10); const ok=(user.history?.[k]||[]).every(Boolean); days.push({k,ok});} historyDots.innerHTML=days.map(d=>`<div class="dot ${d.ok?"ok":""}" title="${d.k}: ${d.ok?"all goals met":"incomplete"}"></div>`).join(""); }

const authSection=$("#authSection"), introSection=$("#introSection"), checkinSection=$("#checkinSection");
$("#btnLogin").addEventListener("click", ()=>{
  const un=$("#username").value.trim(), pw=$("#password").value;
  if(!un||!pw){alert("Enter both username and password.");return;}
  const users=loadUsers();
  if(!users[un]){ users[un]={pass:hash(pw),name:"",motivation:"",onboarded:false,streak:0,history:{},_streakCounted:null,reminder:null,nextDueFreq:null,nextDueInactivity:null}; saveUsers(users); }
  else if(users[un].pass!==hash(pw)){ alert("Wrong password."); return; }
  saveSession({username:un}); showApp();
});
$("#btnNew").addEventListener("click", ()=>{
  const un=$("#username").value.trim(), pw=$("#password").value;
  if(!un||!pw){alert("Enter a username & password to create/reset.");return;}
  const users=loadUsers(); users[un]={pass:hash(pw),name:"",motivation:"",onboarded:false,streak:0,history:{},_streakCounted:null,reminder:null,nextDueFreq:null,nextDueInactivity:null}; saveUsers(users); saveSession({username:un}); showApp(true);
});
$("#btnLogout").addEventListener("click",()=>{ clearSession(); location.reload(); });

function showApp(isNew=false){
  const s=loadSession(); const u=loadUsers();
  if(!s||!u[s.username]){authSection.hidden=false; introSection.hidden=true; checkinSection.hidden=true; return;}
  const user=u[s.username]; authSection.hidden=true;
  if(!user.onboarded||isNew){
    introSection.hidden=false; checkinSection.hidden=true;
    talk("Hi, I‚Äôm Coach Maya. What should I call you, and what‚Äôs your one-line motivation?");
  } else {
    introSection.hidden=true; checkinSection.hidden=false;
    greetUser(user);
    updateHistory(user); updateStreak(user);
    maybeSendOverdueReminder(user);
  }
}
function greetUser(user, first=false){
  const line = first?`Nice to meet you, ${user.name}! I‚Äôll keep your progress on this device.`:`Welcome back, ${user.name}! Ready for today‚Äôs quick WFPB check-in?`;
  talk(line);
  welcomeLine.innerHTML=`Welcome back, <b>${user.name}</b>! Your why: ‚Äú${user.motivation||"‚Äî"}‚Äù.`;
}

/* ====== Onboarding save ====== */
const introMsg=$("#introMsg");
$("#btnSaveIntro").addEventListener("click", async ()=>{
  const s=loadSession(); const users=loadUsers(); const user=users[s.username];
  user.name = $("#displayName").value.trim() || "Friend";
  user.motivation = $("#motivation").value.trim() || "";
  const email=$("#email").value.trim(); const freq=$("#freq").value; const hour=$("#hour").value.trim()||"08:00";
  user.reminder = email ? { email, freq, hour } : null;
  // schedule email reminders
  if(email){
    user.nextDueFreq = computeNextFreqDue(Date.now(), freq, hour);
    user.nextDueInactivity = Date.now() + H12;
    introMsg.textContent="Saved. Sending welcome email‚Ä¶";
    await sendEmail(email, user.name, "Welcome to Coach Maya", `Hi ${user.name}, I'm Coach Maya. We'll use tiny steps toward colorful vegetables, legumes, whole fruit, and whole grains. Your 'why': "${user.motivation}".`);
  } else {
    introMsg.textContent="Saved ‚úì (emails off)";
  }
  user.onboarded = true; saveUsers(users);

  await speakQueue([
    `Hi ${user.name}, I‚Äôm Coach Maya.`,
    "We‚Äôll use small, steady steps to build a whole-food, plant-based lifestyle.",
    "Think colorful vegetables, beans and lentils, whole fruits instead of juice, and whole grains like oats and brown rice.",
    "No pressure, just progress. I‚Äôll be here to nudge, guide, and cheer for you."
  ]);

  introSection.hidden=true; checkinSection.hidden=false; greetUser(user,true);
});

/* ====== Daily check-in ====== */
const qVeg=$("#qVeg"), qLeg=$("#qLeg"), qFruit=$("#qFruit"), qGrain=$("#qGrain"), saveMsg=$("#saveMsg"), result=$("#result");
function normalize(s){ return (s||"").toLowerCase().trim(); }
function isYes(s){ s=normalize(s); return /^(y|yes|ya|done|ok|sure|yep)/.test(s) || /(spinach|kale|broccoli|carrot|pepper|tomato|beet|veg|salad|greens|dal|chana|lentil|bean|hummus|tofu|tempeh|banana|apple|orange|berries|oat|brown rice|whole|wheat|pasta)/.test(s); }
function resFromInput(val, type){
  const s=normalize(val);
  const met = isYes(s) && !/no|none|nah|zero|didn'?t|not/.test(s);
  let tip="";
  if(type==="veg") tip = met? "Great job adding colorful vegetables." : "Add one handful of greens or carrots tomorrow.";
  if(type==="leg") tip = met? "Nice work getting beans or lentils in." : "Try 1/2 cup of beans or lentils ‚Äî canned is fine.";
  if(type==="fruit") tip = met? "Whole fruit over juice is a smart choice." : "Keep one fruit visible so you‚Äôll reach for it.";
  if(type==="grain") tip = met? "Whole-grain swap gives steady energy." : "Swap one refined grain for brown rice or whole-wheat bread.";
  return {met, tip};
}
function incrementStreak(user){
  const todayKey=new Date().toISOString().slice(0,10);
  const yesterday=new Date(); yesterday.setDate((new Date()).getDate()-1);
  const yKey=yesterday.toISOString().slice(0,10);
  const todayComplete=(user.history[todayKey]||[]).every(Boolean);
  const yComplete=(user.history[yKey]||[]).every(Boolean);
  if(todayComplete){ if(user._streakCounted===todayKey) return; user.streak = yComplete ? (user.streak||0)+1 : 1; user._streakCounted=todayKey; }
}
$("#btnSave").addEventListener("click", async ()=>{
  const s=loadSession(); const users=loadUsers(); const user=users[s.username];
  user.history = user.history || {};
  const veg=resFromInput(qVeg.value,"veg"), leg=resFromInput(qLeg.value,"leg"), fru=resFromInput(qFruit.value,"fruit"), gra=resFromInput(qGrain.value,"grain");
  const todayKey=new Date().toISOString().slice(0,10);
  user.history[todayKey]=[veg.met,leg.met,fru.met,gra.met];

  const allMet=[veg.met,leg.met,fru.met,gra.met].every(Boolean);
  if(allMet){ confetti(); talk(`Outstanding, ${user.name}! You met all four goals today.`); result.innerHTML=`<p class="small success"><strong>üéâ Congrats!</strong> All four goals met.</p>`; incrementStreak(user); }
  else { const tips=[veg.tip,leg.tip,fru.tip,gra.tip].filter(Boolean).map(t=>`<li>${t}</li>`).join(""); talk(`Good effort, ${user.name}. Let‚Äôs close the gaps with tiny steps.`); result.innerHTML=`<p class="small danger"><strong>Progress!</strong> Try these tiny steps:</p><ul class="small">${tips}</ul>`; }

  // Inactivity clock resets after engagement
  if(user.reminder?.email){ user.nextDueInactivity = Date.now() + H12; }

  saveMsg.textContent="Saved ‚úì"; setTimeout(()=>saveMsg.textContent="",1200);
  saveUsers(users); updateHistory(user); updateStreak(user);

  const feedback=[veg,leg,fru,gra].map(x=>x.tip);
  await speakQueue([`Welcome back, ${user.name}.`, allMet ? "Four wins today. I‚Äôm proud of you." : "Tiny steps will get us there.", ...feedback.slice(0,3)]);
});

/* ====== Init ====== */
(function init(){
  if(!EMAIL_ENABLED){ console.log("Emails disabled. Set EMAIL_ENABLED=true + keys."); }
  const s=loadSession(); if(s){ showApp(); } else { $("#authSection").hidden=false; }
})();
</script>
</body>
</html>

